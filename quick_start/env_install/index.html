<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://rflypilot.github.io/quick_start/env_install/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>快速使用 - RflyPilot Doc</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u5feb\u901f\u4f7f\u7528";
        var mkdocs_page_input_path = "quick_start\\env_install.md";
        var mkdocs_page_url = "/quick_start/env_install/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> RflyPilot Doc
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Getting Started</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">快速使用</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#0">0 硬件与软件准备</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#1-rflypilot">1 RflyPilot系统配置</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#11">1.1 树莓派固件准备</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#12">1.2 固件下载</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#121">1.2.1 树莓派启动模式</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#122-rflypilot">1.2.2 RflyPilot固件下载</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#13">1.3 系统配置</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#131-bootconfigtxt">1.3.1 配置/boot/config.txt</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#132-bootcmdlinetxt">1.3.2 配置/boot/cmdline.txt</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#133-bootwpa_supplicationconf">1.3.3 配置/boot/wpa_supplication.conf</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#134-ssh">1.3.4 配置SSH</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#14">1.4 树莓派操作系统的使用</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2-windows">2 Windows环境配置</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#21-wsl">2.1 WSL环境配置</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#22-rflypilot">2.2 RflyPilot源码下载</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#23">2.3 文件组织结构</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#3">3 模型的运行</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#31">3.1 仿真参数初始化</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#32">3.2 综合仿真</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#4">4 代码生成</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#41">4.1 控制器代码生成</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#42">4.2 状态估计代码生成</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#43">4.3 无人机模型代码生成</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#5-rflypilot">5 代码的部署编译与RflyPilot</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#51">5.1 代码部署</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#52-rflypilot">5.2 RflyPilot编译</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#53">5.3 飞控程序部署</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#6">6 飞控的运行</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_1">参考资料</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#4_1">4.快速体验</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">基本使用</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../Basic/codegen/">代码生成与交叉编译</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Basic/hardware_connection/">硬件连接</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Basic/simulation/">MIL\SIH\HIL仿真</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Basic/scope/">在线示波器</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Basic/rflysim3d/">RflySim3D显示</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Basic/console/">远程控制台</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Basic/logger/">日志系统</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Basic/calibration/">传感器校准</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Basic/paramupdate/">在线调参</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Basic/experiment/">实飞实验</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mpc/mpc_example/">模型预测控制应用案例</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">开发者文档</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../development/sys_overview/">软硬件架构</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">展望</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../Future/future/">下一代RflyPilot</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Help</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../others/help/">Contribute</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">RflyPilot Doc</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Getting Started &raquo;</li>
      <li>快速使用</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="quick-start">Quick Start</h1>
<p>这部分内容的主要目的是搭建起RflyPilot开发环境</p>
<h2 id="0">0 硬件与软件准备</h2>
<ol>
<li>RflyPilot飞控</li>
<li>装有WSL与MATLAB2022B的Windows电脑</li>
</ol>
<h2 id="1-rflypilot">1 RflyPilot系统配置</h2>
<h3 id="11">1.1 树莓派固件准备</h3>
<p>有以下三种选择:</p>
<ol>
<li>
<p>树莓派官方提供的固件(64位或32位), <a href="https://www.raspberrypi.com/software/">Download</a>. 官方系统需要使用官方工具<a href="https://downloads.raspberrypi.org/imager/imager_latest.exe">Raspberry Pi Imager</a>安装</p>
</li>
<li>
<p><a href="https://navio2.hipi.io/">navio2</a>提供的固件(含实时补丁32位),<a href="https://docs.emlid.com/navio2/configuring-raspberry-pi">Download</a>, 可以使用工具<a href="https://etcher.io/">Etcher</a>安装.</p>
</li>
<li>
<p>也可以使用其他系统如ubuntu, 但是我们没有进行测试. </p>
</li>
</ol>
<h3 id="12">1.2 固件下载</h3>
<p>RflyPilot采用的是树莓派CM4核心板，与树莓派4B标准版不同，它不包含SD卡槽，核心板上默认装有EMMC存储芯片，所以需要将树莓派固件下载到EMMC中。在树莓派4B中可以用SD卡读卡器对树莓派固件进行下载，将固件写入到SD卡中，对于树莓派CM4而言，由于存储芯片无法拆卸，需要修改树莓派CM4的启动模式，令其在电脑上识别为U盘设备，即可安装常规方法进行固件下载。</p>
<h4 id="121">1.2.1 树莓派启动模式</h4>
<p><img alt="RflyPilot拨码开关" src="../img/switch_key.png" /></p>
<table>
<thead>
<tr>
<th>标号</th>
<th>开关</th>
<th>OFF</th>
<th>ON</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>BOOT</td>
<td>从内部存储启动</td>
<td>识别为U盘</td>
</tr>
<tr>
<td>2</td>
<td>DAT(GPIO25)</td>
<td>飞控程序开机自启*</td>
<td>取消自启</td>
</tr>
<tr>
<td>3</td>
<td>SW</td>
<td>SBUS协议</td>
<td>IBUS协议</td>
</tr>
</tbody>
</table>
<p><font face="黑体" color=red size=3>注意：飞控程序开机自启功能目前并未实现</font></p>
<h4 id="122-rflypilot">1.2.2 RflyPilot固件下载</h4>
<ol>
<li>首先需要安装驱动程序，<a href="https://github.com/raspberrypi/usbboot/raw/master/win32/rpiboot_setup.exe">rpiboot</a>，安装完成后运行<code>rpiboot.exe</code>，然后将将RflyPilot拨码开关的<code>BOOT</code>键拨为<code>ON</code>，即识别为U盘。通过USB线连接到电脑。（注意：此时不能将飞控连接到飞机上，以免出现信号异常现象）稍等一会儿，便会看到如下界面
<img alt="Rpiboot界面" src="../img/rpiboot.png" />
最后可以看到新增的两个磁盘
<img alt="树莓派U盘" src="../img/rpiboot_udisk.png" /></li>
<li>树莓派被识别成U盘后，其系统烧写步骤与SD卡烧写方案无异，这里不再赘述，这里我们默认使用的是<strong>navio2</strong>的系统镜像，该镜像具有实时补丁，可以一定程度提高系统实时性。</li>
</ol>
<h3 id="13">1.3 系统配置</h3>
<p>在固件烧写完成后，还不能直接运行RflyPilot软件程序，需要对系统进行一些配置。如WIFI、SSH、引导程序等。这部分修改可以直接在U盘模式下完成。</p>
<h4 id="131-bootconfigtxt">1.3.1 配置<code>/boot/config.txt</code></h4>
<pre><code>[all] 
# enable sc16is752 overlay
dtoverlay=sc16is752-spi1
# enable I2C-1 and set the frequency to 400KHz
# enable spidev0.0
dtparam=spi=on
# enable RC input
enable_uart=1
#init_uart_clock=80000000
#dtoverlay=uart2
#dtoverlay=uart3
#dtoverlay=uart4  ! uart4 conflict with spi0.0
#dtoverlay=uart5
# enable I2C-0
dtparam=i2c_vc=on,i2c_vc_baudrate=1000000
dtparam=i2c_arm=on,i2c_arm_baudrate=1000000
# switch Bluetooth to miniuart
dtoverlay=miniuart-bt
[cm4]
force_turbo=1
core_freq=500
core_freq_min=500
arm_freq=1800
arm_freq_min=1500
start_x=0
# usb otg host mode
dtoverlay=dwc2,dr_mode=host
</code></pre>
<p>注：这里将usb口设置成了host模式，如需要利用树莓派的USB口给其他设备供电，需要短接飞控板上的D1二极管以保障飞控可以为USB设备供电。</p>
<h4 id="132-bootcmdlinetxt">1.3.2 配置<code>/boot/cmdline.txt</code></h4>
<pre><code>dwc_otg.lpm_enable=0 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait isolcpus=2,3
</code></pre>
<p>注：</p>
<ul>
<li>这里<code>isocpus=2,3</code>的意思是隔离CPU2与CPU3，即系统默认不会使用这两个核心，这两个核心将主要被用于运行飞控系统。当前的树莓派CM4，一共4个CPU核心，分别是CPU0\CPU1\CPU2\CPU3。</li>
<li>如果是Rpi官方系统<code>root=/dev/mmcblk0p2</code>的内容可能每次刷固件都是不一样的，也可能和系统版本有关系，笔者这里没有深入了解。</li>
</ul>
<h4 id="133-bootwpa_supplicationconf">1.3.3 配置<code>/boot/wpa_supplication.conf</code></h4>
<pre><code>country=CN
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
network={
    ssid=&quot;xxx&quot;
    psk=&quot;XXXXXXXX&quot;
}
</code></pre>
<p>注：此处为WIFI设置，需要根据实际情况进行配置，RflyPilot将在系统启动时连接该WIFI。</p>
<h4 id="134-ssh">1.3.4 配置SSH</h4>
<p>在<code>boot</code>目录下创建一个空文件，文件名取为<code>ssh</code>即可，此时系统将默认在开始时启动SSH服务。</p>
<p>至此，便完成了RflyPilot飞控操作系统的基本配置，注意，配置完成后，应将<code>BOOT</code>开关拨回<code>OFF</code>，以从内部存储启动系统。</p>
<h4 id="14">1.4 树莓派操作系统的使用</h4>
<p>本小节主要介绍树莓派操作系统的基本使用方法与常用指令。
树莓派上电之后等待一会，这个过程中，飞控的黄色指示灯(ACTION)会闪烁，表示系统正在执行某些任务。最终两颗红色LED会常亮，表示系统启动完成。此时通过SSH即可连接到树莓派系统。这里使用<code>WindTerm</code>作为终端软件进行SSH连接（需要树莓派自动连接WIFI）。值得一提的是，由于树莓派系统资源有限，这里直接使用基于命令行的方式进行了交互，以减低系统自身的消耗。</p>
<p>注意：</p>
<ul>
<li>默认用户名：<code>pi</code></li>
<li>默认密码：<code>raspberry</code></li>
</ul>
<p><img alt="使用WindTerm连接树莓派" src="../img/ssh_shell.png" /></p>
<p>常通过<code>htop</code>指令去查看系统资源使用情况，如下图所示，可以看到CPU3\CPU4并没有被系统所使用，占用率为0</p>
<p><img alt="htop输出" src="../img/htop.png" /></p>
<p>常用命令还有：df ifconfig cp rm ls free top netstat vim</p>
<h2 id="2-windows">2 Windows环境配置</h2>
<p>对于Windows的环境要求如下</p>
<ol>
<li>首先确认开启了<strong>适用于Windows的Linux子系统功能</strong></li>
<li>通过Windows应用商店安装WSL ubuntu18.04版本. </li>
<li>安装后打开, 等待配置后到提示输入用户名的阶段时不要输入用户名直接关闭ubuntu 18.04的终端.</li>
<li>安装Virtual Studio 2017用于代码生成</li>
<li>安装MATLAB 2022b</li>
</ol>
<p>注意：这里使用WSL子系统的主要目的是用于<a href="https://baike.baidu.com/item/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/10916911">交叉编译</a>，这里主要考虑到，飞控代码在树莓派机载端直接编译会非常慢，而通过Linux系统计算机编译会快很多。为了提高开发效率，RflyPilot选择使用交叉编译的方式在Linux端直接编译得到可以用在树莓派端执行的可执行文件。</p>
<h3 id="21-wsl">2.1 WSL环境配置</h3>
<p>进入WSL后，执行命令</p>
<pre><code>sudo apt install cmake
sudo apt install gcc-arm-linux-gnueabihf
sudo apt install g++-arm-linux-gnueabihf
sudo apt install sshpass
</code></pre>
<h3 id="22-rflypilot">2.2 RflyPilot源码下载</h3>
<p>RflyPilot的源码主要分为两大部分：RflyPilot飞控系统接口（C++代码）与用于飞控设计的模型文件(MATLAB)。</p>
<p>RflyPilot源码: <a href="https://gitee.com/nash2zhao/RflyPilot.git">https://gitee.com/nash2zhao/RflyPilot.git</a></p>
<p>RflyPilot MATLAB源码: <a href="https://github.com/umview/raspberry_fc_matlab.git">https://github.com/umview/raspberry_fc_matlab.git</a></p>
<p>RflyPilot飞控系统接口采用高效的C++代码完成，为RflyPilot提供基本的飞控功能，包括传感器读取任务、执行器输出任务、控制器与状态估计接口、日志系统、传感器校准模块等等。在常规的飞控算法设计过程中，一般不需要修改这部分的代码。</p>
<p>飞控模型文件主要包含控制器模型、无人机模型、状态估计器模型等。这部分模型可以直接进行数值仿真，用于前期的控制系统验证。设计好的飞控可以进行代码生成，进而嵌入到RflyPilot飞控系统中。这部分内容是开发者需要经常修改调试的内容。值得一提的是，为了更好地处理代码迁移与编译的问题，课题组也针对性地开发了一套工具——RflyPilotTools，用于简化复杂的操作流程。</p>
<p>使用命令</p>
<pre><code>git clone https://gitee.com/nash2zhao/RflyPilot.git
git clone https://github.com/umview/raspberry_fc_matlab.git
</code></pre>
<p>由于MATLAB模型中还未包含状态估计模型和无人机模型，还需要执行子模块更新指令，方可完成对模型的完整下载。</p>
<pre><code>cd raspberry_fc_matlab
git submodule update --init --recursive
cd Estimator
git checkout master
cd ../Model
git checkout master
cd ..
</code></pre>
<h3 id="23">2.3 文件组织结构</h3>
<pre><code>.
├── Estimator
│   ├── AttitudeEstimator.slx（姿态估计仿真模型）
│   ├── AttitudeEstimatorParameters.m（姿态估计器的参数初始化脚本）
│   ├── Estimator.sldd（用于存储估计器参数）
│   ├── Inteface.sldd（代码生成的接口定义文件）
│   ├── PositionEstimator.slx（位置估计器模型）
│   ├── PositionEstimatorParameters.m（位置估计器的参数初始化脚本）
│   ├── README.md
│   ├── doc
│   │   └── estimatordoc.tex（状态估计的说明文档）
├── MATLABApp
│   └── RflyPilotToolBox.mlappinstall（RflyPilot安装包）
├── MIL
│   ├── ControlInit_vz.m（控制器初始化脚本）
│   ├── MPCControllerCodeGen_Vz.slx（四旋翼NMPC控制器模型）
│   ├── MPC_HIL.slx（综合仿真模型）
│   ├── README.txt
│   ├── SIH_Model.slx（SIH仿真模型）
│   ├── quad_make_solver_vz.m（用于生成四旋翼NMPC求解器）
│   └── usrController.slx（用于代码生成的控制器模型）
├── Model
│   ├── H250Model.slx（四旋翼模型文件）
│   ├── ModelParam_H2504S.m（四旋翼模型参数初始化文件）
├── Raspberry_fc_matlab.prj（工程文件）
├── cache
├── debug_tools（用于存放RflyPilot的在线示波器）
├── i2c2pwm
├── log_analysis（用于log存储与分析的文件）
├── mathlib（数学库）
├── nmpc_solver_vz.cpp（nmpc求解器相关文件）
├── nmpc_solver_vz.tlc（nmpc求解器相关文件）
├── nmpc_solver_vz_wrapper.cpp（nmpc求解器相关文件）
├── resources (Simulink工程缓存文件)
├── simulink_codegen（代码生成的目标文件夹）
└── swfiles（RflyPilot飞控外壳3D打印文件）
</code></pre>
<h2 id="3">3 模型的运行</h2>
<p>本小节将介绍如何运行数值仿真。</p>
<h3 id="31">3.1 仿真参数初始化</h3>
<p>首先在MATLAB中打开工程文件<code>Raspberry_fc_matlab.prj</code>，然后分别运行如下脚本</p>
<ul>
<li>MIL/ControlInit_vz.m</li>
<li>Estimator/AttitudeEstimatorParameters.m</li>
<li>Estimator/PositionEstimatorParameters.m</li>
<li>Model/ModelParam_H2504S.m</li>
</ul>
<p>注意：为避免后续仿真过程中文件路径发生错误等问题<strong>强烈</strong>建议在后续进行仿真的过程中，工作目录依然保持在工程根目录下，即Raspberry_fc_matlab目录下。</p>
<h3 id="32">3.2 综合仿真</h3>
<p>打开MIL/MIL_HIL.slx模型
<img alt="MIL_HIL综合仿真模型" src="../img/MIL_HIL.png" /></p>
<p>这是综合仿真模型，它整合了遥控器输入接口，控制器，无人机模型，状态估计器以及3D显示输出模块，是一个较为全面的仿真模型。这里的控制器与无人机模型部分均使用了Simulink的ModelReferance功能(类似与函数调用)，通过规范化模型输入输出接口，调用相应的子模型，如，控制器模型调用了<code>MPCControllerCodeGen.slx</code>，而无人机模型则调用了<code>H250Model.slx</code>，状态估计系统则在内部分别调用了<code>AttitudeEstimator</code>与<code>PostionEstimator</code>。如下图所示。</p>
<p><img alt="参考模型" src="../img/modelref.png" /></p>
<p>在部署完<a href="../../mpc/mpc_example/">NMPC求解器</a>后，可以直接运行综合仿真模型，并打开<code>RflySim3D</code>，进行位姿显示。默认模型采用Dashboard进行指令输入，如下图所示（在Viewer中）。</p>
<p><img alt="默认控制台" src="../img/dashboard.png" />
<img alt="Rflysim3D视角" src="../img/quadcopter_rflysim3d.png" /></p>
<p>注意：需要保证NMPC求解器源码文件夹<code>acado_MPC</code>在工程根目录下，同时确保其已经加载到工程索引路径中。</p>
<h2 id="4">4 代码生成</h2>
<p>在进行数值仿真之后，我们已经对系统的性能有了一个基本的判断。可以进行下一步的验证工作，包括HIL(半物理仿真)、SIH(硬件仿真)、EXP(实飞实验)。然而这些验证模式都需要将仿真程序转化为可以进行实际部署的形式，所以将这些模型进行代码生成则是一条必经之路。</p>
<h3 id="41">4.1 控制器代码生成</h3>
<p>打开<code>MIL/usrController.slx</code>模型，可以看到（下图）其中左侧为模型输入接口，其均为结构体类型，其中包含多种数据，模型右侧为PWM信号输出接口与调试数据输出接口。其中右侧对话框中的外部数据用于加载接口定义文件<code>Interface.sldd</code>。这个文件定义的接口与RflyPilot飞控中的C++代码接口一致，是沟通代码生成与RflyPilot基础系统的桥梁。同时这个模型是将原有<code>MPCControllerCodeGen_Vz.slx</code>进行了封装，这样的处理方法有利于代码生成后接口的兼容，也有助于进行控制模型的快速切换与部署。</p>
<p><img alt="usrController模型信息" src="../img/usrController.png" /></p>
<p>在上述设置完成之后，即可对该控制器模型进行代码生成。进入APP下的Embedded Code工具箱，选择进行<strong>编译</strong>。</p>
<p>注意：代码生成过程中可能会遇到错误，可以尝试将acado_MPC文件夹下的文件进行重新加载，或尝试清除<code>cache</code>和<code>simulink_codegen</code>文件夹下的内容后重新生成。
最终可以得到如下界面。</p>
<p><img alt="控制器代码生成结果" src="../img/codegen_result.png" /></p>
<h3 id="42">4.2 状态估计代码生成</h3>
<p>状态估计部分的代码生成分为姿态估计器代码生成与位置估计代码生成。首先介绍姿态估计代码生成，打开<code>Estimator/AttitudeEstimator.slx</code>模型，如下图所示。其代码生成步骤与控制器代码生成步骤类似，这里不再赘述。
<img alt="姿态估计模型" src="../img/attest_codegen.png" />
除了姿态信息，位置信息也不可或缺。位置估计器的模型为<code>Estimator/PositionEstimator.slx</code>，位置估计模型的代码生成步骤与姿态估计模型类似，这里同样不再赘述。</p>
<h3 id="43">4.3 无人机模型代码生成</h3>
<p>至此，控制器、状态估计器的模型均已被生成为代码的形式，无人机的仿真模型同样可以进行代码生成，这里主要用作SIH仿真中的被控对象，即只需要一共飞控硬件尽可以进行飞行仿真，这种仿真模式主要用于验证控制器在实际飞控平台中的运行是否正常。
打开模型<code>SIH_Model.slx</code>，这里同样使用了参考模型的模型搭建方式，使用的模型是<code>Model/H250Model2.slx</code>（与数值仿真模型<code>Model/H250Model.slx</code>的区别详见<code>Model/README.md</code>），使用的接口文件同样是<code>Interface.sldd</code>，其代码生成方式也不再赘述了。</p>
<p><img alt="sih_codegen_err" src="../img/err_sih_codegen.png" /></p>
<p>注意：在生成过程中可能遇到如下报错，直接点击“修复”即可。</p>
<h2 id="5-rflypilot">5 代码的部署编译与RflyPilot</h2>
<h3 id="51">5.1 代码部署</h3>
<p>将四大功能模块进行代码生成后，可以得到如下结果，在<code>simulink_codegen</code>文件夹下。可以看到生成的代码已被打包为zip文件。</p>
<p><img alt="代码生成的结果" src="../img/simulink_codegen.png" /></p>
<p>如何将其生成的代码部署到实际飞控中呢？此时就需要通过RflyPilotTools进行衔接。</p>
<p><img alt="RflyPilotTools" src="../img/rflypilottools.png" /></p>
<p>RflyPilotTools是一款基于MATLAB的工具箱，它的安装包位于<code>MATLABApp/RflyPilotToolBox.mlappinstall</code>，在工程根目录下，双击即可安装，最终会显示在MATLAB工具箱界面中。</p>
<p><img alt="MATLABAPP" src="../img/rflypilottool_app.png" /></p>
<p>首次使用RflyPilotTool需要对其进行配置，主要配置选项为<code>RflyPilot Path</code>，即RflyPilot源码的路径，至于<code>CodeGen Path</code>与<code>Unzip Path</code>则分别为代码生成源码的路径和生成压缩包的路径，这里保持默认即可。配置完成后，点击“Save Setting”，即可保持配置到工程根目录下的<code>rflypilottoolbox.mat</code>中。</p>
<p><img alt="rflypilottool路径配置" src="../img/rflypilottools_1.png" /></p>
<p>配置完成后，依次点击“Update Estimator” “Update SIH Model” “Update Controller"即可做到“一键部署”，即将代码复制到相应的源码文件夹中。与之对应的文件夹分别为<code>estimator_codegen</code>,<code>sih_codegen</code>,<code>controller_codegen</code>。在更新完成后，读者可以在自行去相应的文件夹查看相应的源码。</p>
<h3 id="52-rflypilot">5.2 RflyPilot编译</h3>
<p>RflyPilot的交叉编译是在WSL系统中进行的。但得益于RflyPilotTool，这个步骤被进一步简化。
首先在RflyPilot源码文件夹中创建<code>build</code>文件夹，用于存储编译后的文件。然后在RflyPilotTool中，点击“Build”，即可进行交叉编译。编译过程中的输出可以在MATLAB命令行中查看。
输出结果为</p>
<pre><code>-- Configuring done
-- Generating done
-- Build files have been written to: /mnt/d/nash.zhao/RflyPilot_DEMO/RflyPilot/build
[ 14%] Built target confc
[ 20%] Built target controller_codegen
[ 27%] Built target basic_controller_codegen
[ 31%] Built target libsbus
[ 40%] Built target estimator_codegen
[ 55%] Built target sih_codegen
Scanning dependencies of target rflypilot
[ 56%] Building CXX object CMakeFiles/rflypilot.dir/src/application/attitudeEstimator_thread.cpp.o
[ 57%] Building CXX object CMakeFiles/rflypilot.dir/src/application/ulog_thread.cpp.o
[ 57%] Building CXX object CMakeFiles/rflypilot.dir/src/application/usrController_thread.cpp.o
[ 58%] Building CXX object CMakeFiles/rflypilot.dir/src/simulink_utility/norm_afMWvhHe.cpp.o
[ 59%] Building CXX object CMakeFiles/rflypilot.dir/src/application/system_app.cpp.o
[ 60%] Building CXX object CMakeFiles/rflypilot.dir/src/simulink_utility/norm_a2pQkYtO.cpp.o
[ 61%] Building CXX object CMakeFiles/rflypilot.dir/src/simulink_utility/rtGetInf.cpp.o
[ 62%] Building CXX object CMakeFiles/rflypilot.dir/src/simulink_utility/rtGetNaN.cpp.o
[ 63%] Building CXX object CMakeFiles/rflypilot.dir/src/simulink_utility/rt_atan2d_snf.cpp.o
[ 63%] Building CXX object CMakeFiles/rflypilot.dir/src/simulink_utility/rt_atan2f_snf.cpp.o
[ 64%] Building CXX object CMakeFiles/rflypilot.dir/src/simulink_utility/rt_nonfinite.cpp.o
[ 65%] Building CXX object CMakeFiles/rflypilot.dir/src/simulink_utility/rt_r32zcfcn.cpp.o
[ 66%] Building CXX object CMakeFiles/rflypilot.dir/src/simulink_utility/rt_zcfcn.cpp.o
[ 67%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/px4lib/test_time.cpp.o
[ 68%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/posix/i2c.cpp.o
[ 68%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/posix/spi.cpp.o
[ 69%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/actuator/pca9685/pca9685.cpp.o
[ 70%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/actuator/fpga/actuator_fpga.cpp.o
[ 71%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/rc/sbus/sbus_api.cpp.o
[ 72%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/imu/icm42688p/ICM42688P.cpp.o
[ 73%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/imu/icm20689new/ICM20689.cpp.o
[ 73%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/imu/gyroscope/PX4Gyroscope.cpp.o
[ 74%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/imu/accelerometer/PX4Accelerometer.cpp.o
[ 75%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/magnetometer/ist8310/ist8310.cpp.o
[ 76%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/magnetometer/qmc5883l/QMC5883L.cpp.o
[ 77%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/barometer/ms5611/ms5611.cpp.o
[ 78%] Building CXX object CMakeFiles/rflypilot.dir/src/drivers/gps/gps_api.cpp.o
[ 78%] Building C object CMakeFiles/rflypilot.dir/src/3rdparty/sbus/src/tty/sbus_tty_linux.c.o
[ 79%] Building C object CMakeFiles/rflypilot.dir/src/3rdparty/sbus/src/tty/sbus_low_latency_linux.c.o
[ 80%] Building C object CMakeFiles/rflypilot.dir/src/3rdparty/sbus/src/tty/sbus_low_latency_none.c.o
[ 81%] Building CXX object CMakeFiles/rflypilot.dir/src/3rdparty/sbus/src/decoder/DecoderFSM.cpp.o
[ 82%] Building C object CMakeFiles/rflypilot.dir/src/3rdparty/sbus/src/decoder/packet_decoder.c.o
[ 83%] Building CXX object CMakeFiles/rflypilot.dir/src/3rdparty/sbus/src/driver/SBUS.cpp.o
[ 83%] Linking CXX executable rflypilot
[100%] Built target rflypilot
</code></pre>
<p>其背后在WSL中执行的命令为</p>
<pre><code>cd build
cmake .. &amp;&amp; make -j128
</code></pre>
<h3 id="53">5.3 飞控程序部署</h3>
<p>交叉编译完成后，将在<code>build</code>目录下生成可执行文件<code>rflypilot</code>，该可执行文件只能运行于树莓派系统中。故需要上传到树莓派中才可以运行。于此同时，除了<code>rflypilot</code>文件以外，还有一些配置文件需要被同时上传到树莓派中</p>
<ul>
<li><code>parameter.txt</code>——用于存储自定义的飞控参数</li>
<li><code>rflypilot.txt</code>——RflyPilot配置文件</li>
</ul>
<p>点击“Upload”后，即可在RflyPilot飞控中看到更新后的文件。</p>
<p><font face="黑体" color=red size=3>注：第一次下载需要提前用WSL ubuntu 18.04登录树莓派的SSH, 并建立文件夹RflyPilot_Project\RflyPilot</font></p>
<pre><code>dpi@navio:~ $ cd RflyPilot_Project/RflyPilot/
pi@navio:~/RflyPilot_Project/RflyPilot $ ls
parameter.txt  rflypilot  rflypilot.txt
pi@navio:~/RflyPilot_Project/RflyPilot $ 
</code></pre>
<p>至此，便完成了飞控程序的部署。</p>
<h2 id="6">6 飞控的运行</h2>
<p>为了方便演示，这里以SIH仿真为例，进行飞控的仿真验证。
首先修改配置文件，将运行模式修改为SIH模式，即，<code>valid_mode = 1</code>。然后将<code>scope_ip</code>与<code>station_ip</code>修改为电脑IP。</p>
<pre><code>########################### SYSTEM PARAMETER ###################
#validation mode SIH:1 HIL:2 EXP:3 OFFBOARD:4
valid_mode = 1
#SIH mode use real state
sih_use_real_state = 1
#system sample rate
imu_rate = 800 
mag_rate = 95 # max rate 100Hz
controller_rate = 333
attitude_est_rate = 500
lpe_rate = 500
#imu cutoff in Hz
accel_cutoff_hz = 50 
gyro_cutoff_hz = 50
#scheduler_mode delay:1 adaptive_delay:2 timer:3(NOT RECOMMENDED!)
scheduler_mode = 2 
# msg logger enable
sys_log_en = 1
est_log_en = 0
ctrl_log_en = 1
# msg scope enable
sys_scope_en = 1
est_scope_en = 0
ctrl_scope_en = 1
# string
scope_ip = &quot;192.168.199.233&quot; # 152
station_ip = &quot;192.168.199.233&quot;
log_dir = &quot;.&quot;
########################## USER DEFINED PARAMETER #########################
</code></pre>
<p>然后通过命令<code>./rflypilot</code>即可运行飞控于SIH模式。
系统启动时，界面如下</p>
<p><img alt="sih_boot" src="../img/sih_boot.png" /></p>
<p>系统正常启动后，界面如下
<img alt="console" src="../img/console.png" /></p>
<h2 id="_1">参考资料</h2>
<p><a href="https://www.raspberrypi.com/documentation/computers/config_txt.html#overclocking-options">config.txt树莓派官方说明</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/76437760">树莓派超频</a></p>
<p><a href="https://blog.csdn.net/cyuyan112233/article/details/44577033">树莓派配置文档config.txt说明</a></p>
<h2 id="4_1">4.快速体验</h2>
<ol>
<li>打开MATLAB 2022b, 打开RflyPilot MATLAB工程, 安装RflyPilot ToolBox</li>
<li>代码生成姿态估计, 位置估计, SIH模型, 示例控制器.</li>
<li>第一次下载需要提前用WSL ubuntu 18.04登录树莓派的SSH, 并建立文件夹RflyPilot_Project\RflyPilot</li>
<li>在MTLAB APP中打开安装的RflyPilot ToolBox进行操作完成编译下载工作</li>
<li>SSH中<code>cd /home/pi/RflyPilot_Project/RflyPilot/</code>并<code>./rflypilot</code> or <code>sudo ./rflypilot</code><blockquote>
<p>如果不使用sudo可能无法正常向指定IP地址发送UDP数据，暂时影响SIH模式运行</p>
</blockquote>
</li>
</ol>
<!-- ### 代码生成

- If the acado lib is used, do not copy the files `acado_solver_mex.c` and `make_acado_solver.m` into RflyPilot project.

- Such as `nmpc_solver_vz_wrapper.cpp`, the file generated by s-function builder not included in code gen folder need to be copied into RflyPilot project.

### 编译构建
- 将配置文件复制到与可执行文件相同的目录下 -->
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../Basic/codegen/" class="btn btn-neutral float-right" title="代码生成与交叉编译">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
      <span><a href="../../Basic/codegen/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
